when:
  branch: master
  event: push

steps:
  # Step 1: Build notification
  - name: notify-start
    image: alpine:latest
    commands:
      - "echo 'Starting MRadio deployment pipeline...'"
      - "echo 'Branch: ${CI_COMMIT_BRANCH}'"
      - "echo 'Commit: ${CI_COMMIT_SHA}'"
      - "echo 'Author: ${CI_COMMIT_AUTHOR}'"

  # Step 2: Deploy to Oracle Cloud Server
  - name: deploy
    image: appleboy/drone-ssh
    settings:
      host: 140.238.251.85
      username: ubuntu
      key:
        from_secret: ssh_private_key
      port: 22
      command_timeout: 5m
      script:
        - "echo 'üì° Connected to Oracle Cloud server'"
        - "cd /home/ubuntu/docker/radio"
        - "chmod +x run.sh"
        - "./run.sh radio-main"

  # Step 3: Health check
  - name: health-check
    image: curlimages/curl:latest
    commands:
      - "sleep 10"
      - "echo 'üè• Performing health check...'"
      - "curl -f http://140.238.251.85:9126/ || echo '‚ö†Ô∏è  Service not responding yet'"

  # Step 4: Success notification
  - name: notify-success
    image: alpine:latest
    commands:
      - "echo '‚úÖ Deployment successful!'"
      - "echo 'üéµ MRadio is now live at http://140.238.251.85:9126'"
    when:
      status: success

  # Step 5: Failure notification
  - name: notify-failure
    image: alpine:latest
    commands:
      - "echo '‚ùå Deployment failed!'"
      - "echo 'Please check the logs above for errors'"
    when:
      status: failure
