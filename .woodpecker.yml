when:
  branch: master
  event: push

steps:
  # Step 1: Build notification
  - name: notify-start
    image: alpine:latest
    commands:
      - echo "Starting MRadio deployment pipeline..."
      - echo "Branch: ${CI_COMMIT_BRANCH}"
      - echo "Commit: ${CI_COMMIT_SHA}"
      - echo "Author: ${CI_COMMIT_AUTHOR}"

  # ğŸ” Step 2: Verify SSH key is loaded & valid
  - name: verify-ssh-key
    image: alpine:latest
    secrets:
      - ssh_private_key
    commands:
      - apk add --no-cache openssh
      - echo "ğŸ” Checking SSH key injection..."
      - test -n "$ssh_private_key" && echo "âœ… SSH key is present" || echo "âŒ SSH key is EMPTY"
      - echo "ğŸ” Validating SSH private key format..."
      - echo "$ssh_private_key" | ssh-keygen -lf - || echo "âŒ Invalid or corrupted SSH key"
      - echo "ğŸ” First line of key:"
      - echo "$ssh_private_key" | sed -n '1p' | cat -A
      - echo "ğŸ” Last line of key:"
      - echo "$ssh_private_key" | sed -n '$p' | cat -A

  # ğŸš€ Step 3: Deploy to Oracle Cloud Server
  - name: deploy
    image: appleboy/drone-ssh
    settings:
      host: 140.238.251.85
      username: ubuntu
      key:
        from_secret: ssh_private_key
      port: 22
      command_timeout: 5m
      script:
        - echo "ğŸ“¡ Connected to Oracle Cloud server"
        - cd /home/ubuntu/docker/radio
        - chmod +x run.sh
        - ./run.sh radio-main

  # ğŸ¥ Step 4: Health check
  - name: health-check
    image: curlimages/curl:latest
    commands:
      - sleep 10
      - echo "ğŸ¥ Performing health check..."
      - curl -f http://140.238.251.85:9126/ || echo "âš ï¸ Service not responding yet"

  # âœ… Step 5: Success notification
  - name: notify-success
    image: alpine:latest
    commands:
      - echo "âœ… Deployment successful!"
      - echo "ğŸµ MRadio is now live at http://140.238.251.85:9126"
    when:
      status: success

  # âŒ Step 6: Failure notification
  - name: notify-failure
    image: alpine:latest
    commands:
      - echo "âŒ Deployment failed!"
      - echo "Please check the logs above for errors"
    when:
      status: failure
